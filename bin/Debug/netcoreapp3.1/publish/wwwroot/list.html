<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing</title>
    <link rel="shortcut icon" href="favicon.png" type="image/png">
</head>

<body>
    <main>
        <p><button id="create" disabled>Create Room</button></p>

        <p>You are : <b id="you"></b></p>

        <table>
            <thead>
                <tr>
                    <th>Room Names</th>
                    <th>Join Room</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="2">No rooms, why not create one? :)</td>
                </tr>
            </tbody>
        </table>
    </main>

    <!-- <script src="js/jquery.min.js"></script> -->
    <script src="js/signalr.js"></script>
    <script>
        // ========================================================================================
        // General
        // ========================================================================================

        const name = sessionStorage.getItem('name');
        if (!name) {
            location = 'main.html';
            throw 'ERROR: Invalid name';
        }

        document.getElementById('you').innerText = name;

        // ========================================================================================
        // Events
        // ========================================================================================

        //Create room Id
        document.getElementById('create').onclick = async e => {
            let roomId = await con.invoke('CreateRoom');
            location = `index.html?roomId=${roomId}`;
        };

        //Redirect to roomId with button
        function join(roomid) {
            location = `index.html?roomId=${roomid}`;
        };

        // ========================================================================================
        // Connect
        // ========================================================================================
        const con = new signalR.HubConnectionBuilder()
            .withUrl('/hub?page=list') // virtual websocket page
            .build();

        con.onclose(err => {
            alert('Disconnected');
            location = 'main.html?';
        });

        con.on('UpdateList', list => {
            let html = '';
            //room.id should replace with room.name
            for (let room of list) {
                html += `
                    <tr>
                        <td>$${room.id}</td>   
                        <td><button onclick="join('${room.id}')">Join</button></td>
                    </tr>
                `;
            }

            if (list.length == 0) {
                html = '<tr><td colspan="2">No rooms, why not create one? :)</td></tr>';
            }
            document.querySelector('tbody').innerHTML = html;
        });

        con.start().then(e => {
            document.getElementById('create').disabled = false;
        });
    </script>
</body>

</html>